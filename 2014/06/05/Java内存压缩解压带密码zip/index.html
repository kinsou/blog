<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Java内存压缩解压带密码zip | zkname</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java内存压缩解压带密码zip</h1><a id="logo" href="/.">zkname</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java内存压缩解压带密码zip</h1><div class="post-meta">2014-06-05<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span></div><div class="post-content"><h2 id="压缩类ZipEncryptOutputStream-java"><a href="#压缩类ZipEncryptOutputStream-java" class="headerlink" title="压缩类ZipEncryptOutputStream.java"></a>压缩类ZipEncryptOutputStream.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.zk.zip.ZipExpand.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Output stream that can be used to password-protect zip files.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;h3&gt;Example usage:&lt;/h3&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Creating a password-protected zip file:&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *  ZipEncryptOutputStream zeos = new ZipEncryptOutputStream(new FileOutputStream(fileName), password);</span></span><br><span class="line"><span class="comment"> *  ZipOutputStream zos = new ZipOuputStream(zdis);</span></span><br><span class="line"><span class="comment"> *  ... create zip file using the standard JDK ZipOutputStream in zos variable ...</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Converting a plain zip file to a password-protected zip file:&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *  FileInputStream src = new FileInputStream(srcFile);</span></span><br><span class="line"><span class="comment"> *  ZipEncryptOutputStream dest = new ZipEncryptOutputStream(new FileOutputStream(destFile), password);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  // should wrap with try-catch-finally, do the close in finally</span></span><br><span class="line"><span class="comment"> *  int b;</span></span><br><span class="line"><span class="comment"> *  while ((b = src.read()) &gt; -1) &#123;</span></span><br><span class="line"><span class="comment"> *      dest.write(b);</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  src.close();</span></span><br><span class="line"><span class="comment"> *  dest.close();</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipEncryptOutputStream</span> <span class="keyword">extends</span> <span class="title">OutputStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> keys[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pwdKeys[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> copyBytes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> skipBytes;</span><br><span class="line">    <span class="keyword">private</span> State state = State.NEW_SECTION;</span><br><span class="line">    <span class="keyword">private</span> State futureState;</span><br><span class="line">    <span class="keyword">private</span> Section section;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] decryptHeader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;<span class="keyword">int</span>[][]&gt; crcAndSize = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">int</span>[][]&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Integer&gt; localHeaderOffset = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="keyword">int</span>[]&gt; fileData;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] condition;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fileIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] buffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bufOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fileSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bytesWritten;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> centralRepoOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ROW_SIZE = <span class="number">65536</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convenience constructor taking password as a string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delegate Output stream to write the password-protected zip to.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password Password to use for protecting the zip.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZipEncryptOutputStream</span><span class="params">(OutputStream delegate, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(delegate, password.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Safer version of the constructor. Takes password as a char array that can</span></span><br><span class="line"><span class="comment">     * be nulled right after calling this constructor instead of a string that may</span></span><br><span class="line"><span class="comment">     * stay visible on the heap for the duration of application run time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delegate Output stream to write the password-protected zip to.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password Password to use for protecting the zip.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZipEncryptOutputStream</span><span class="params">(OutputStream delegate, <span class="keyword">char</span>[] password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">        pwdKeys[<span class="number">0</span>] = <span class="number">305419896</span>;</span><br><span class="line">        pwdKeys[<span class="number">1</span>] = <span class="number">591751049</span>;</span><br><span class="line">        pwdKeys[<span class="number">2</span>] = <span class="number">878082192</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; password.length; i++) &#123;</span><br><span class="line">            ZipExpand.updateKeys((<span class="keyword">byte</span>) (password[i] &amp; <span class="number">0xff</span>), pwdKeys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;NEW_SECTION, SECTION_HEADER, FLAGS, REPO_OFFSET, CRC, FILE_HEADER_OFFSET,</span><br><span class="line">        COMPRESSED_SIZE_READ, HEADER, DATA, FILE_BUFFERED, BUFFER, BUFFER_COPY, BUFFER_UNTIL, TAIL&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">Section</span> </span>&#123;LFH, CFH, ECD&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (skipBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            skipBytes--;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (copyBytes == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                <span class="keyword">case</span> NEW_SECTION:</span><br><span class="line">                    <span class="keyword">if</span> (b != <span class="number">0x50</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unexpected value read at offset &quot;</span> + bytesWritten + <span class="string">&quot;: &quot;</span> + b + <span class="string">&quot; (expected: &quot;</span> + <span class="number">0x50</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    buffer(<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>], State.SECTION_HEADER, <span class="number">0x50</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> SECTION_HEADER:</span><br><span class="line">                    identifySectionHeader();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FLAGS:</span><br><span class="line">                    copyBytes = <span class="number">7</span>;</span><br><span class="line">                    state = State.CRC;</span><br><span class="line">                    <span class="keyword">if</span> (section == Section.LFH) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((b &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;ZIP already password protected.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ((b &amp; <span class="number">64</span>) == <span class="number">64</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Strong encryption used.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ((b &amp; <span class="number">8</span>) == <span class="number">8</span>) &#123;</span><br><span class="line">                            bufferUntil(State.FILE_BUFFERED, CFH_SIGNATURE, LFH_SIGNATURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    b = b &amp; <span class="number">0xf7</span> | <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CRC:</span><br><span class="line">                    <span class="keyword">if</span> (section == Section.CFH) &#123;</span><br><span class="line">                        <span class="keyword">int</span>[][] cns = crcAndSize.get(fileIndex);</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                                writeToDelegate(cns[j][i]);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        skipBytes = <span class="number">11</span>;</span><br><span class="line">                        copyBytes = <span class="number">14</span>;</span><br><span class="line">                        state = State.FILE_HEADER_OFFSET;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">int</span>[] cns = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">16</span>];</span><br><span class="line">                        buffer(cns, State.COMPRESSED_SIZE_READ, b);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> FILE_HEADER_OFFSET:</span><br><span class="line">                    writeAsBytes(localHeaderOffset.get(fileIndex));</span><br><span class="line">                    fileIndex++;</span><br><span class="line">                    skipBytes = <span class="number">3</span>;</span><br><span class="line">                    copyBytesUntil(State.SECTION_HEADER, CFH_SIGNATURE, ECD_SIGNATURE);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> COMPRESSED_SIZE_READ:</span><br><span class="line">                    <span class="keyword">int</span>[][] cns = <span class="keyword">new</span> <span class="keyword">int</span>[][] &#123;</span><br><span class="line">                        &#123;buffer[<span class="number">0</span>], buffer[<span class="number">1</span>], buffer[<span class="number">2</span>], buffer[<span class="number">3</span>]&#125;,</span><br><span class="line">                        &#123;buffer[<span class="number">4</span>], buffer[<span class="number">5</span>], buffer[<span class="number">6</span>], buffer[<span class="number">7</span>]&#125;,</span><br><span class="line">                        &#123;buffer[<span class="number">8</span>], buffer[<span class="number">9</span>], buffer[<span class="number">10</span>], buffer[<span class="number">11</span>]&#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    adjustSize(cns[<span class="number">1</span>]);</span><br><span class="line">                    crcAndSize.add(cns);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                            writeToDelegate(cns[j][i]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    copyBytes = buffer[<span class="number">12</span>] + buffer[<span class="number">14</span>] + (buffer[<span class="number">13</span>] + buffer[<span class="number">15</span>]) * <span class="number">256</span> - <span class="number">1</span>;</span><br><span class="line">                    state = State.HEADER;</span><br><span class="line">                    <span class="keyword">if</span> (copyBytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No file name stored in the zip file.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HEADER:</span><br><span class="line">                    writeDecryptHeader();</span><br><span class="line">                    fileSize = decode(crcAndSize.get(crcAndSize.size() - <span class="number">1</span>)[<span class="number">1</span>]);</span><br><span class="line">                    state = State.DATA;</span><br><span class="line">                    <span class="comment">// intentionally no break</span></span><br><span class="line">                <span class="keyword">case</span> DATA:</span><br><span class="line">                    b = encrypt(b);</span><br><span class="line">                    fileSize--;</span><br><span class="line">                    <span class="keyword">if</span> (fileSize == <span class="number">0</span>) &#123;</span><br><span class="line">                        state = State.NEW_SECTION;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BUFFER:</span><br><span class="line">                    buffer[bufOffset] = b;</span><br><span class="line">                    bufOffset++;</span><br><span class="line">                    <span class="keyword">if</span> (bufOffset == buffer.length) &#123;</span><br><span class="line">                        state = futureState;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> BUFFER_COPY:</span><br><span class="line">                    buffer[bufOffset] = b;</span><br><span class="line">                    <span class="keyword">if</span> (checkCondition()) &#123;</span><br><span class="line">                        bufOffset = <span class="number">0</span>;</span><br><span class="line">                        state = futureState;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BUFFER_UNTIL:</span><br><span class="line">                    <span class="keyword">int</span> col = fileSize % ROW_SIZE;</span><br><span class="line">                    <span class="keyword">if</span> (col == <span class="number">0</span>) &#123;</span><br><span class="line">                        fileData.add(<span class="keyword">new</span> <span class="keyword">int</span>[ROW_SIZE]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span>[] row = fileData.get(fileData.size() - <span class="number">1</span>);</span><br><span class="line">                    row[col] = b;</span><br><span class="line">                    buffer[bufOffset] = b;</span><br><span class="line">                    fileSize++;</span><br><span class="line">                    <span class="keyword">if</span> (checkCondition()) &#123;</span><br><span class="line">                        fileSize -= buffer.length;</span><br><span class="line">                        state = futureState;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> FILE_BUFFERED:</span><br><span class="line">                    row = fileData.get(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">int</span> r = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">int</span> pointer = <span class="number">16</span> + row[<span class="number">12</span>] + row[<span class="number">14</span>] + (row[<span class="number">13</span>] + row[<span class="number">15</span>]) * <span class="number">256</span>;</span><br><span class="line">                    cns = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][<span class="number">4</span>];</span><br><span class="line">                    readFromFileBuffer(fileSize - <span class="number">12</span>, cns[<span class="number">0</span>]);</span><br><span class="line">                    readFromFileBuffer(fileSize - <span class="number">8</span>, cns[<span class="number">1</span>]);</span><br><span class="line">                    readFromFileBuffer(fileSize - <span class="number">4</span>, cns[<span class="number">2</span>]);</span><br><span class="line">                    fileSize = decode(cns[<span class="number">1</span>]);</span><br><span class="line">                    adjustSize(cns[<span class="number">1</span>]);</span><br><span class="line">                    crcAndSize.add(cns);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                        row[i] = cns[<span class="number">0</span>][i];</span><br><span class="line">                        row[i + <span class="number">4</span>] = cns[<span class="number">1</span>][i];</span><br><span class="line">                        row[i + <span class="number">8</span>] = cns[<span class="number">2</span>][i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointer; i++) &#123;</span><br><span class="line">                        writeToDelegate(row[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    writeDecryptHeader();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fileSize; i++) &#123;</span><br><span class="line">                        writeToDelegate(encrypt(row[pointer]));</span><br><span class="line">                        pointer++;</span><br><span class="line">                        <span class="keyword">if</span> (pointer == ROW_SIZE) &#123;</span><br><span class="line">                            pointer = <span class="number">0</span>;</span><br><span class="line">                            r++;</span><br><span class="line">                            row = fileData.get(r);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    fileData = <span class="keyword">null</span>;</span><br><span class="line">                    identifySectionHeader();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> REPO_OFFSET:</span><br><span class="line">                    writeAsBytes(centralRepoOffset);</span><br><span class="line">                    skipBytes = <span class="number">3</span>;</span><br><span class="line">                    state = State.TAIL;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> TAIL:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            copyBytes--;</span><br><span class="line">        &#125;</span><br><span class="line">        writeToDelegate(b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeToDelegate</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        delegate.write(b);</span><br><span class="line">        bytesWritten++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">adjustSize</span><span class="params">(<span class="keyword">int</span>[] values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> inc = DECRYPT_HEADER_SIZE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            values[i] = values[i] + inc;</span><br><span class="line">            inc = values[i] &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            values[i] &amp;= <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decode</span><span class="params">(<span class="keyword">int</span>[] value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value[<span class="number">0</span>] + (value[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + (value[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) + (value[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeAsBytes</span><span class="params">(<span class="keyword">int</span> value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            writeToDelegate(value &amp; <span class="number">0xff</span>);</span><br><span class="line">            value &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">identifySectionHeader</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(buffer, LFH_SIGNATURE)) &#123;</span><br><span class="line">            section = Section.LFH;</span><br><span class="line">            copyBytes = <span class="number">1</span>;</span><br><span class="line">            state = State.FLAGS;</span><br><span class="line">            localHeaderOffset.add(bytesWritten);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Arrays.equals(buffer, CFH_SIGNATURE)) &#123;</span><br><span class="line">            section = Section.CFH;</span><br><span class="line">            copyBytes = <span class="number">3</span>;</span><br><span class="line">            state = State.FLAGS;</span><br><span class="line">            <span class="keyword">if</span> (centralRepoOffset == <span class="number">0</span>) &#123;</span><br><span class="line">                centralRepoOffset = bytesWritten;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Arrays.equals(buffer, ECD_SIGNATURE)) &#123;</span><br><span class="line">            section = Section.ECD;</span><br><span class="line">            copyBytes = <span class="number">11</span>;</span><br><span class="line">            state = State.REPO_OFFSET;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unknown header: &quot;</span> + Arrays.asList(buffer).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        flushBuffer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readFromFileBuffer</span><span class="params">(<span class="keyword">int</span> offset, <span class="keyword">int</span>[] target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> r = offset / ROW_SIZE;</span><br><span class="line">        <span class="keyword">int</span> c = offset % ROW_SIZE;</span><br><span class="line">        <span class="keyword">int</span>[] row = fileData.get(r);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; target.length; i++) &#123;</span><br><span class="line">            target[i] = row[c];</span><br><span class="line">            c++;</span><br><span class="line">            <span class="keyword">if</span> (c == ROW_SIZE) &#123;</span><br><span class="line">                c = <span class="number">0</span>;</span><br><span class="line">                r++;</span><br><span class="line">                row = fileData.get(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">        delegate.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initKeys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.arraycopy(pwdKeys, <span class="number">0</span>, keys, <span class="number">0</span>, keys.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateKeys</span><span class="params">(<span class="keyword">byte</span> charAt)</span> </span>&#123;</span><br><span class="line">        ZipExpand.updateKeys(charAt, keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">encryptByte</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = keys[<span class="number">2</span>] | <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">byte</span>) ((temp * (temp ^ <span class="number">1</span>)) &gt;&gt;&gt; <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">encrypt</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> newB = (b ^ encryptByte()) &amp; <span class="number">0xff</span>;</span><br><span class="line">        updateKeys((<span class="keyword">byte</span>) b);</span><br><span class="line">        <span class="keyword">return</span> newB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeDecryptHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        initKeys();</span><br><span class="line">        <span class="keyword">int</span>[] crc = crcAndSize.get(crcAndSize.size() - <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">        SecureRandom random = <span class="keyword">new</span> SecureRandom();</span><br><span class="line">        decryptHeader = <span class="keyword">new</span> <span class="keyword">byte</span>[DECRYPT_HEADER_SIZE];</span><br><span class="line">        random.nextBytes(decryptHeader);</span><br><span class="line">        decryptHeader[DECRYPT_HEADER_SIZE - <span class="number">2</span>] = (<span class="keyword">byte</span>) crc[<span class="number">2</span>];</span><br><span class="line">        decryptHeader[DECRYPT_HEADER_SIZE - <span class="number">1</span>] = (<span class="keyword">byte</span>) crc[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DECRYPT_HEADER_SIZE; i++) &#123;</span><br><span class="line">            writeToDelegate(encrypt(decryptHeader[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buffer</span><span class="params">(<span class="keyword">int</span>[] values, State state, <span class="keyword">int</span>... knownValues)</span> </span>&#123;</span><br><span class="line">        System.arraycopy(knownValues, <span class="number">0</span>, values, <span class="number">0</span>, knownValues.length);</span><br><span class="line">        buffer = values;</span><br><span class="line">        bufOffset = knownValues.length;</span><br><span class="line">        <span class="keyword">this</span>.state = State.BUFFER;</span><br><span class="line">        futureState = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bufOffset; i++) &#123;</span><br><span class="line">            writeToDelegate(buffer[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">copyBytesUntil</span><span class="params">(State state, <span class="keyword">int</span>[]... condition)</span> </span>&#123;</span><br><span class="line">        futureState = state;</span><br><span class="line">        <span class="keyword">this</span>.condition = condition;</span><br><span class="line">        bufOffset = <span class="number">0</span>;</span><br><span class="line">        buffer = <span class="keyword">new</span> <span class="keyword">int</span>[condition[<span class="number">0</span>].length];</span><br><span class="line">        <span class="keyword">this</span>.state = State.BUFFER_COPY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bufferUntil</span><span class="params">(State state, <span class="keyword">int</span>[]... condition)</span> </span>&#123;</span><br><span class="line">        copyBytesUntil(state, condition);</span><br><span class="line">        fileData = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">int</span>[]&gt;();</span><br><span class="line">        fileSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.state = State.BUFFER_UNTIL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> equals = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; condition.length; i++) &#123;</span><br><span class="line">            equals = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= bufOffset; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (condition[i][j] != buffer[j]) &#123;</span><br><span class="line">                    equals = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (equals) &#123;</span><br><span class="line">                bufOffset++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!equals) &#123;</span><br><span class="line">            bufOffset = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> equals &amp;&amp; (buffer.length == bufOffset);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##解压缩类ZipDecryptInputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.zk.zip.ZipExpand.DD_SIGNATURE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.zk.zip.ZipExpand.DECRYPT_HEADER_SIZE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.zk.zip.ZipExpand.LFH_SIGNATURE;</span><br><span class="line"><span class="keyword">import</span> com.zk.zip.ZipExpand.Section;</span><br><span class="line"><span class="keyword">import</span> com.zk.zip.ZipExpand.State;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Input stream converting a password-protected zip to an unprotected zip.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;h3&gt;Example usage:&lt;/h3&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Reading a password-protected zip from file:&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *  ZipDecryptInputStream zdis = new ZipDecryptInputStream(new FileInputStream(fileName), password);</span></span><br><span class="line"><span class="comment"> *  ZipInputStream zis = new ZipInputStream(zdis);</span></span><br><span class="line"><span class="comment"> *  ... read the zip file from zis - the standard JDK ZipInputStream ...</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Converting a password-protected zip file to an unprotected zip file:&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *  ZipDecryptInputStream src = new ZipDecryptInputStream(new FileInputStream(srcFile), password);</span></span><br><span class="line"><span class="comment"> *  FileOutputStream dest = new FileOutputStream(destFile);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  // should wrap with try-catch-finally, do the close in finally</span></span><br><span class="line"><span class="comment"> *  int b;</span></span><br><span class="line"><span class="comment"> *  while ((b = src.read()) &gt; -1) &#123;</span></span><br><span class="line"><span class="comment"> *      dest.write(b);</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  src.close();</span></span><br><span class="line"><span class="comment"> *  dest.close();</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipDecryptInputStream</span> <span class="keyword">extends</span> <span class="title">InputStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> keys[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pwdKeys[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> State state = State.SIGNATURE;</span><br><span class="line">    <span class="keyword">private</span> Section section;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> skipBytes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> compressedSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> crc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance of the stream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stream Input stream serving the password-protected zip file to be decrypted.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password Password to be used to decrypt the password-protected zip file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZipDecryptInputStream</span><span class="params">(InputStream stream, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(stream, password.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Safer constructor. Takes password as a char array that can be nulled right after</span></span><br><span class="line"><span class="comment">     * calling this constructor instead of a string that may be visible on the heap for</span></span><br><span class="line"><span class="comment">     * the duration of application run time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stream Input stream serving the password-protected zip file.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password Password to use for decrypting the zip file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZipDecryptInputStream</span><span class="params">(InputStream stream, <span class="keyword">char</span>[] password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = stream;</span><br><span class="line">        pwdKeys[<span class="number">0</span>] = <span class="number">305419896</span>;</span><br><span class="line">        pwdKeys[<span class="number">1</span>] = <span class="number">591751049</span>;</span><br><span class="line">        pwdKeys[<span class="number">2</span>] = <span class="number">878082192</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; password.length; i++) &#123;</span><br><span class="line">            ZipExpand.updateKeys((<span class="keyword">byte</span>) (password[i] &amp; <span class="number">0xff</span>), pwdKeys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;incomplete-switch&quot;)</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = delegateRead();</span><br><span class="line">        <span class="keyword">if</span> (skipBytes == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                <span class="keyword">case</span> SIGNATURE:</span><br><span class="line">                    <span class="keyword">if</span> (!peekAheadEquals(LFH_SIGNATURE)) &#123;</span><br><span class="line">                        state = State.TAIL;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        section = Section.FILE_HEADER;</span><br><span class="line">                        skipBytes = <span class="number">5</span>;</span><br><span class="line">                        state = State.FLAGS;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FLAGS:</span><br><span class="line">                    <span class="keyword">if</span> ((result &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;ZIP not password protected.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((result &amp; <span class="number">64</span>) == <span class="number">64</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Strong encryption used.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((result &amp; <span class="number">8</span>) == <span class="number">8</span>) &#123;</span><br><span class="line">                        compressedSize = -<span class="number">1</span>;</span><br><span class="line">                        state = State.FN_LENGTH;</span><br><span class="line">                        skipBytes = <span class="number">19</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        state = State.CRC;</span><br><span class="line">                        skipBytes = <span class="number">10</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    result -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CRC:</span><br><span class="line">                    crc = result;</span><br><span class="line">                    state = State.COMPRESSED_SIZE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> COMPRESSED_SIZE:</span><br><span class="line">                    <span class="keyword">int</span>[] values = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">                    peekAhead(values);</span><br><span class="line">                    compressedSize = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">int</span> valueInc = DECRYPT_HEADER_SIZE;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                        compressedSize += values[i] &lt;&lt; (<span class="number">8</span> * i);</span><br><span class="line">                        values[i] -= valueInc;</span><br><span class="line">                        <span class="keyword">if</span> (values[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            valueInc = <span class="number">1</span>;</span><br><span class="line">                            values[i] += <span class="number">256</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            valueInc = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    overrideBuffer(values);</span><br><span class="line">                    result = values[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">if</span> (section == Section.DATA_DESCRIPTOR) &#123;</span><br><span class="line">                        state = State.SIGNATURE;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        state = State.FN_LENGTH;</span><br><span class="line">                    &#125;</span><br><span class="line">                    skipBytes = <span class="number">7</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FN_LENGTH:</span><br><span class="line">                    values = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">                    peekAhead(values);</span><br><span class="line">                    skipBytes = <span class="number">3</span> + values[<span class="number">0</span>] + values[<span class="number">2</span>] + (values[<span class="number">1</span>] + values[<span class="number">3</span>]) * <span class="number">256</span>;</span><br><span class="line">                    state = State.HEADER;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HEADER:</span><br><span class="line">                    section = Section.FILE_DATA;</span><br><span class="line">                    initKeys();</span><br><span class="line">                    <span class="keyword">byte</span> lastValue = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DECRYPT_HEADER_SIZE; i++) &#123;</span><br><span class="line">                        lastValue = (<span class="keyword">byte</span>) (result ^ decryptByte());</span><br><span class="line">                        updateKeys(lastValue);</span><br><span class="line">                        result = delegateRead();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((lastValue &amp; <span class="number">0xff</span>) != crc) &#123;</span><br><span class="line"><span class="comment">//                        throw new IllegalStateException(&quot;Wrong password!&quot;);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    compressedSize -= DECRYPT_HEADER_SIZE;</span><br><span class="line">                    state = State.DATA;</span><br><span class="line">                    <span class="comment">// intentionally no break</span></span><br><span class="line">                <span class="keyword">case</span> DATA:</span><br><span class="line">                    <span class="keyword">if</span> (compressedSize == -<span class="number">1</span> &amp;&amp; peekAheadEquals(DD_SIGNATURE)) &#123;</span><br><span class="line">                        section = Section.DATA_DESCRIPTOR;</span><br><span class="line">                        skipBytes = <span class="number">5</span>;</span><br><span class="line">                        state = State.CRC;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        result = (result ^ decryptByte()) &amp; <span class="number">0xff</span>;</span><br><span class="line">                        updateKeys((<span class="keyword">byte</span>) result);</span><br><span class="line">                        compressedSize--;</span><br><span class="line">                        <span class="keyword">if</span> (compressedSize == <span class="number">0</span>) &#123;</span><br><span class="line">                            state = State.SIGNATURE;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TAIL:</span><br><span class="line">                    <span class="comment">// do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            skipBytes--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bufOffset = BUF_SIZE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] buf = <span class="keyword">new</span> <span class="keyword">int</span>[BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">delegateRead</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        bufOffset++;</span><br><span class="line">        <span class="keyword">if</span> (bufOffset &gt;= BUF_SIZE) &#123;</span><br><span class="line">            fetchData(<span class="number">0</span>);</span><br><span class="line">            bufOffset = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf[bufOffset];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">peekAheadEquals</span><span class="params">(<span class="keyword">int</span>[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        prepareBuffer(values);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buf[bufOffset + i] != values[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareBuffer</span><span class="params">(<span class="keyword">int</span>[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (values.length &gt; (BUF_SIZE - bufOffset)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = bufOffset; i &lt; BUF_SIZE; i++) &#123;</span><br><span class="line">                buf[i - bufOffset] = buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            fetchData(BUF_SIZE - bufOffset);</span><br><span class="line">            bufOffset = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">peekAhead</span><span class="params">(<span class="keyword">int</span>[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        prepareBuffer(values);</span><br><span class="line">        System.arraycopy(buf, bufOffset, values, <span class="number">0</span>, values.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">overrideBuffer</span><span class="params">(<span class="keyword">int</span>[] values)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        prepareBuffer(values);</span><br><span class="line">        System.arraycopy(values, <span class="number">0</span>, buf, bufOffset, values.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchData</span><span class="params">(<span class="keyword">int</span> offset)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = offset; i &lt; BUF_SIZE; i++) &#123;</span><br><span class="line">            buf[i] = delegate.read();</span><br><span class="line">            <span class="keyword">if</span> (buf[i] == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        delegate.close();</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initKeys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.arraycopy(pwdKeys, <span class="number">0</span>, keys, <span class="number">0</span>, keys.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateKeys</span><span class="params">(<span class="keyword">byte</span> charAt)</span> </span>&#123;</span><br><span class="line">        ZipExpand.updateKeys(charAt, keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">decryptByte</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = keys[<span class="number">2</span>] | <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">byte</span>) ((temp * (temp ^ <span class="number">1</span>)) &gt;&gt;&gt; <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##解密工具类ZipExpand.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZipExpand</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] CRC_TABLE = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="comment">// compute the table</span></span><br><span class="line">    <span class="comment">// (could also have it pre-computed - see http://snippets.dzone.com/tag/crc32)</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> r = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((r &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                    r = (r &gt;&gt;&gt; <span class="number">1</span>) ^ <span class="number">0xedb88320</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            CRC_TABLE[i] = r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DECRYPT_HEADER_SIZE = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] CFH_SIGNATURE = &#123;<span class="number">0x50</span>, <span class="number">0x4b</span>, <span class="number">0x01</span>, <span class="number">0x02</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] LFH_SIGNATURE = &#123;<span class="number">0x50</span>, <span class="number">0x4b</span>, <span class="number">0x03</span>, <span class="number">0x04</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] ECD_SIGNATURE = &#123;<span class="number">0x50</span>, <span class="number">0x4b</span>, <span class="number">0x05</span>, <span class="number">0x06</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] DD_SIGNATURE = &#123;<span class="number">0x50</span>, <span class="number">0x4b</span>, <span class="number">0x07</span>, <span class="number">0x08</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateKeys</span><span class="params">(<span class="keyword">byte</span> charAt, <span class="keyword">int</span>[] keys)</span> </span>&#123;</span><br><span class="line">        keys[<span class="number">0</span>] = crc32(keys[<span class="number">0</span>], charAt);</span><br><span class="line">        keys[<span class="number">1</span>] += keys[<span class="number">0</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">        keys[<span class="number">1</span>] = keys[<span class="number">1</span>] * <span class="number">134775813</span> + <span class="number">1</span>;</span><br><span class="line">        keys[<span class="number">2</span>] = crc32(keys[<span class="number">2</span>], (<span class="keyword">byte</span>) (keys[<span class="number">1</span>] &gt;&gt; <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">crc32</span><span class="params">(<span class="keyword">int</span> oldCrc, <span class="keyword">byte</span> charAt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((oldCrc &gt;&gt;&gt; <span class="number">8</span>) ^ CRC_TABLE[(oldCrc ^ charAt) &amp; <span class="number">0xff</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        SIGNATURE, FLAGS, COMPRESSED_SIZE, FN_LENGTH, EF_LENGTH, HEADER, DATA, TAIL, CRC</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">Section</span> </span>&#123;</span><br><span class="line">        FILE_HEADER, FILE_DATA, DATA_DESCRIPTOR</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">boolean</span> a=<span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">boolean</span> b=a==<span class="keyword">false</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 压缩</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span>(a)&#123;</span><br><span class="line">			   <span class="comment">//读取文件流</span></span><br><span class="line">				List&lt;InputStream&gt; list=<span class="keyword">new</span> ArrayList&lt;InputStream&gt;();</span><br><span class="line">				list.add(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\zk\\Desktop\\a.txt&quot;</span>)));</span><br><span class="line">				list.add(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\zk\\Desktop\\b.txt&quot;</span>)));</span><br><span class="line">				list.add(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\zk\\Desktop\\c.txt&quot;</span>)));</span><br><span class="line">				<span class="comment">//获取输出流</span></span><br><span class="line">				ByteArrayOutputStream array=writeZipOutputStream(list.toArray(<span class="keyword">new</span> FileInputStream[<span class="number">0</span>]),<span class="keyword">new</span> String[]&#123;<span class="string">&quot;a.txt&quot;</span>,<span class="string">&quot;b.txt&quot;</span>,<span class="string">&quot;c.txt&quot;</span>&#125;, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">				<span class="comment">//写入文件</span></span><br><span class="line">				File file=<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\zk\\Desktop\\a.zip&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">				file.createNewFile();</span><br><span class="line">				&#125;</span><br><span class="line">				DataOutputStream to=<span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">				to.write(array.toByteArray());</span><br><span class="line">				to.close();</span><br><span class="line">				array.close();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 解压</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span>(b)&#123;</span><br><span class="line">			   <span class="comment">//获取文件字节数组</span></span><br><span class="line">				File file=<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\zk\\Desktop\\Desktop.zip&quot;</span>);</span><br><span class="line">				<span class="keyword">byte</span>[] data =<span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) file.length()];</span><br><span class="line">				FileInputStream fileInputStream=<span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">				fileInputStream.read(data);</span><br><span class="line">				<span class="comment">//解压文件获取文本内容</span></span><br><span class="line">				StringBuffer sb=readZip(data,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">				fileInputStream.close();</span><br><span class="line">				System.out.println(sb);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 压缩</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> inputStreams 输入流数组</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> fileName 文件名数组</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteArrayOutputStream <span class="title">writeZipOutputStream</span><span class="params">(InputStream [] inputStreams,String [] fileName,String password)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		ZipOutputStream zos = <span class="keyword">null</span>;</span><br><span class="line">		ByteArrayOutputStream baos=<span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			baos=<span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">			zos = <span class="keyword">new</span> ZipOutputStream(<span class="keyword">new</span> ZipEncryptOutputStream(baos, password));</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputStreams.length; i++) &#123;</span><br><span class="line">		        ZipEntry ze = <span class="keyword">new</span> ZipEntry(fileName[i]);</span><br><span class="line">		        zos.putNextEntry(ze);</span><br><span class="line">		        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		        <span class="keyword">try</span> &#123;</span><br><span class="line">		        	is = inputStreams[i];</span><br><span class="line">			        <span class="keyword">int</span> b;</span><br><span class="line">			        <span class="keyword">while</span> ((b = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">			            zos.write(b);</span><br><span class="line">			        &#125;</span><br><span class="line">				&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">					<span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">						is.close();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(zos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">				zos.closeEntry();</span><br><span class="line">				zos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> baos;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解压缩</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data zip字节数组</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> password zip密码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringBuffer <span class="title">readZip</span><span class="params">(<span class="keyword">byte</span>[] data,String password)</span> <span class="keyword">throws</span> IOException  </span>&#123;</span><br><span class="line">		StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		ZipInputStream zin = <span class="keyword">null</span>;</span><br><span class="line">		DataInputStream dis = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			zin = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> ZipDecryptInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> ByteArrayInputStream(data)), password));</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(zin);<span class="comment">//用ZIP输入流构建DataInputStream     </span></span><br><span class="line">			ZipEntry ze;</span><br><span class="line">			<span class="keyword">while</span> ((ze = zin.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (ze.isDirectory()) &#123;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">long</span> size = ze.getSize();</span><br><span class="line">					System.out.println(ze.getName());</span><br><span class="line">					<span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">						BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							<span class="keyword">byte</span>[] content = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) ze.getSize()];</span><br><span class="line">							dis.readFully(content);</span><br><span class="line">							br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> ByteArrayInputStream(content)));</span><br><span class="line">							String line;</span><br><span class="line">							<span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">								sb.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">							&#125;</span><br><span class="line">							</span><br><span class="line">						&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">							<span class="keyword">if</span>(br!=<span class="keyword">null</span>)</span><br><span class="line">								br.close();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(zin!=<span class="keyword">null</span>)&#123;</span><br><span class="line">				zin.closeEntry();</span><br><span class="line">				zin.close();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(dis!=<span class="keyword">null</span>)</span><br><span class="line">				dis.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sb;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Java/"><i class="fa fa-tag"></i>Java</a><a href="/tags/Zip/"><i class="fa fa-tag"></i>Zip</a></div><div class="post-nav"><a class="pre" href="/2014/08/04/maven%20debug%20%E6%96%AD%E7%82%B9%E5%AE%9A%E4%BD%8D%20source%20jar/">maven debug 断点定位 source jar</a><a class="next" href="/2013/05/13/Centos%E5%AE%89%E8%A3%85gcc%20gcc-c++/">Centos安装gcc gcc-c++</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.zkname.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Centos/">Centos</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Clojure/">Clojure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Debian/">Debian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SecureCRT/">SecureCRT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shadowsocks/">Shadowsocks</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SoftEtherVPN/">SoftEtherVPN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ubuntu/">Ubuntu</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Ubuntu/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ubuntu/r8125/">r8125</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/deepin-wine-qq-wechat/">deepin wine qq wechat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/eclipse/">eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/google/">google</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B3%A8%E5%86%8C%E7%A0%81/">注册码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/jetty/" style="font-size: 15px;">jetty</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/jetty9/" style="font-size: 15px;">jetty9</a> <a href="/tags/Debian/" style="font-size: 15px;">Debian</a> <a href="/tags/Google/" style="font-size: 15px;">Google</a> <a href="/tags/Chrome/" style="font-size: 15px;">Chrome</a> <a href="/tags/%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/" style="font-size: 15px;">磁盘性能</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/SecureCRT/" style="font-size: 15px;">SecureCRT</a> <a href="/tags/VPM/" style="font-size: 15px;">VPM</a> <a href="/tags/NTP/" style="font-size: 15px;">NTP</a> <a href="/tags/%E7%A1%AC%E7%9B%98%E5%88%86%E5%8C%BA%E6%8C%82%E8%BD%BD/" style="font-size: 15px;">硬盘分区挂载</a> <a href="/tags/deepin/" style="font-size: 15px;">deepin</a> <a href="/tags/wine/" style="font-size: 15px;">wine</a> <a href="/tags/qq/" style="font-size: 15px;">qq</a> <a href="/tags/wechat/" style="font-size: 15px;">wechat</a> <a href="/tags/Centos/" style="font-size: 15px;">Centos</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Clojure/" style="font-size: 15px;">Clojure</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Eclipse/" style="font-size: 15px;">Eclipse</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/bbr/" style="font-size: 15px;">bbr</a> <a href="/tags/%E6%90%AC%E7%93%A6%E5%B7%A5/" style="font-size: 15px;">搬瓦工</a> <a href="/tags/%E6%B3%A8%E5%86%8C%E7%A0%81/" style="font-size: 15px;">注册码</a> <a href="/tags/MarkdownPad/" style="font-size: 15px;">MarkdownPad</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/ssr/" style="font-size: 15px;">ssr</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/Crontab/" style="font-size: 15px;">Crontab</a> <a href="/tags/Cygwin/" style="font-size: 15px;">Cygwin</a> <a href="/tags/eclipse/" style="font-size: 15px;">eclipse</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/google-voice/" style="font-size: 15px;">google voice</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/workflow/" style="font-size: 15px;">workflow</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/DNSmasq/" style="font-size: 15px;">DNSmasq</a> <a href="/tags/Wechat/" style="font-size: 15px;">Wechat</a> <a href="/tags/kcptun/" style="font-size: 15px;">kcptun</a> <a href="/tags/xkcptun/" style="font-size: 15px;">xkcptun</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">  shadowsocks</a> <a href="/tags/%E6%9E%81%E8%B7%AF%E7%94%B1/" style="font-size: 15px;">极路由</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">深度学习</a> <a href="/tags/Zip/" style="font-size: 15px;">Zip</a> <a href="/tags/r8125/" style="font-size: 15px;">r8125</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/12/ubuntu%E5%AE%89%E8%A3%85N%E5%8D%A1%E9%A9%B1%E5%8A%A8The%20Nouveau%20kernel%20driver%20is%20currently%20in%20use%20by%20your%20system/">ubuntu安装N卡驱动The Nouveau kernel driver is currently in use by your system</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/ubuntu%E5%BC%80%E5%90%AFssh%20root%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95/">ubuntu开启ssh root密码登录</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/ubuntu%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E6%89%A9%E5%AE%B9/">ubuntu磁盘空间扩容</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/ubuntu%E5%AE%89%E8%A3%85r8125%E7%BD%91%E5%8D%A12.5G%E9%A9%B1%E5%8A%A8/">ubuntu安装r8125网卡2.5G驱动</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/nvidia-docker2%E5%AE%89%E8%A3%85/">nvidia-docker2安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/grub%E5%8A%A0%E5%AF%86%E7%A0%81/">grub加密码</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/29/ubuntu%E7%A1%AC%E7%9B%98%E5%88%86%E5%8C%BA%E6%8C%82%E8%BD%BD/">ubuntu硬盘分区挂载</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/29/Linux%20iotop%20io%20%E6%80%A7%E8%83%BD%E6%9F%A5%E7%9C%8B/">Linux iotop io 性能查看</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/01/Linux%20iostat%20io%20%E6%80%A7%E8%83%BD%E6%9F%A5%E7%9C%8B/">Linux iostat io 性能查看</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/02/Ubuntu18.04%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/">Ubuntu18.04开机启动脚本</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">zkname.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>